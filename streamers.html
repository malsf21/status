<!DOCTYPE html>
<html lang="en">
	<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Status | By Matthew Wang</title>
		<link rel="icon" href="css/favicon.ico" />
    <link rel="stylesheet" href="css/bootstrap.css" />
		<link rel="stylesheet" href="css/font-awesome.css" />
  </head>
  <body>
    <div class="container" style="padding-top:10px;">
      <div class="jumbotron">
        <div class="row">
          <div class="col-md-9">
            <h1 class="page-header">Status : Streamers <small><a href="http://twitch.tv"><span class="fa fa-twitch" style="color:purple;"></span></a></small></h1>
            <h3>Hey<span class="username"></span>! <small>Let's take a look at your favourite streamers.</small></h3>
          </div>
          <div class="col-md-3">
            <h4><button class="btn btn-block btn-primary" style="text-align:left;"><span class="fa fa-search"></span> Browse Profiles</button></h4>
            <h4><button class="btn btn-block btn-success" style="text-align:left;" data-toggle="modal" data-target="#editUserModal"><span class="fa fa-pencil"></span> Edit User Profile</button></h4>
            <h4><button class="btn btn-block btn-danger" style="text-align:left;"><span class="fa fa-remove"></span> Delete User Profile</button></h4>
          </div>
        </div>
      </div>
      <div class="row" id="streamer-container">
      </div>
    </div>
    <div class="modal fade" tabindex="-1" role="dialog" id="createUserModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-title">Welcome!</h2>
          </div>
          <div class="modal-body">
            <h3>Hey there!</h3>
            <p>Welcome to Status: Streamers. We've noticed that you haven't been here yet. Do you mind if we ask you a bit about yourself, so we can personalize your experience for you?</p>
            <form method="post" onsubmit="submitCreate()">
            <h3>Name:</h3>
            <input type="text" id="create-name" name="name" class="form-control" required="" placeholder="John Smith">
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Save changes</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" tabindex="-1" role="dialog" id="editUserModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-title">Edit User Profile</h2>
          </div>
          <div class="modal-body">
            <h3>Hey <span class="username">there</span>!</h3>
            <p>If you want to edit the streamers that show up, you can add or remove them here!</p>
              <div class="panel panel-default">
                <div class="panel-body">
                  <div class="row">
                    <div class="col-sm-3">
                      <input type="text" id="new-streamer-name" name="new-streamer-name" class="form-control" required="" placeholder="Name">
                    </div>
                    <div class="col-sm-5">
                      <input type="text" id="new-streamer-twitch" name="new-streamer-name" class="form-control" required="" placeholder="Twitch Username">
                    </div>
                    <div class="col-sm-3" style="color:white;text-align:right;">
                      <button class="btn btn-success" onclick="addStreamerItem('#new-streamer-list',$('#new-streamer-name').val(),$('#new-streamer-twitch').val());addStreamerData($('#new-streamer-name').val(),$('#new-streamer-twitch').val())"><span class="fa fa-plus"></span></button> <button class="btn btn-danger"><span class="fa fa-ban"></span></button>
                    </div>
                  </div>
                </div>
              </div>
            <div id="new-streamer-list">
            </div>
          </div>
          <div class="modal-footer">
            <form method="post" onsubmit="submitCreate()">
              <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
              <button type="submit" class="btn btn-primary">Save changes</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script src="js/jquery.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/js.cookie.min.js"></script>
  <script src="js/structure.js"></script>
  <script src="js/twitch_parser.js"></script>
  <script>

    var template = {"username" : "Matt","lastlogin" : 0, "data" : {"malsf21" : {"name" : "malsf21", "twitch" : "malsf21"},"Dyrus" : {"name" : "Dyrus", "twitch" : "TSM_Dyrus"}}};

    $(document).on('click', '.list-close', function () {
      $(this).parents('div.panel').fadeOut();
    });

    function submitCreate(){
      var username = $('#create-name').val();
      makeCookie(username);
    }

    function makeCookie(username){
      var current_time = new Date();
      Cookies.set("streamerData", template/*{"username" : username,"lastlogin" : current_time.getTime(), "data" : {"malsf21" : {"name" : "malsf21", "twitch" : "malsf21"}}}*//*,10000*/);
    }
    function updateCookie(username,dataset){
      var current_time = new Date();
      Cookies.set("streamerData", {"username" : username,"lastlogin" : current_time.getTime(), "data" : dataset}/*,10000*/);
    }

    function addStreamerItem(container,name,twitch){
      if (!(name in streamerListData)){
        $(container).append('<div class="panel panel-default"><div class="panel-body"><div class="row"><div class="col-sm-3" style="text-align:center;"><h4>' + name + '</h4></div><div class="col-sm-5" style="text-align:center;"><h4><a href="http://twitch.tv/'+ twitch + '/">'+ twitch +'</a></h4></div><div class="col-sm-3" style="color:white;text-align:right;"><button class="btn btn-danger list-close" onclick="removeStreamerData(' + name + ')"><span class="fa fa-remove"></span></button></div></div></div></div>');
      }
    }
    function addStreamerData(name,twitch){
      if (!(name in streamerListData)){
        var tempDict = {};
        tempDict['name'] = name;
        tempDict['twitch'] = twitch;
        streamerListData[name] = tempDict;
        console.log(streamerListData);
      }
    }
    function removeStreamerData(name){

    }

    function buildStreams(streamers,container){
      var counter = 0;
      for (var key in streamers) {
        var streamData = betterTwitchFetch(streamers[key]["twitch"]);
        if (counter%3 == 1 && counter > 1){
          $(container).append('</div><div class="row">');
        }
        // this part looks super messy, and that's because it is. Unfortunately, with how appending divs works, I have to do it this way.
        if (streamData == false){
          $(container).append('<div class="col-sm-4"><div class="well"><h3><span class="label label-danger"> <span class="fa fa-ban"></span> ' + streamers[key]["name"] + ' isn\'t streaming</span></h3><h5>Tune in to ' + streamers[key]["name"] + '\'s channel <a href="http://twitch.tv/'+ streamers[key]["twitch"] +'">here.</a></h5></div></div>');
          /* Here's the clean version of this: (with a template)
          <div class="col-sm-4">
            <div class="well">
              <h3><span class="label label-danger"> <span class="fa fa-ban"></span> Bjergsen isn't streaming</span></h3>
              <h5>Tune in to Bjergsen's channel <a href="http://twitch.tv/">here.</a></h5>
            </div>
          </div>
          Except, Bjergsen is replaced by the name of the streamer based on the key, and the twitch address is added with the key's twitch element.
          */
        }
        else{
          $(container).append('<div class="col-sm-4"><div class="well"><h3><span class="label label-success"> <span class="fa fa-twitch"></span> ' + streamers[key]["name"] + ' is streaming</span></h3><h4><span class="label label-info"><span class="fa fa-gamepad"></span> ' + streamData + '</span></h4><h5>Watch ' + streamers[key]["name"] + ' live <a href="http://twitch.tv/'+ streamers[key]["twitch"] +'">here.</a></h5></div></div>');
          /* Here's a clean templated version of this
          <div class="col-sm-4">
            <div class="well">
              <h3><span class="label label-success"> <span class="fa fa-twitch"></span> Shroud is streaming</span></h3>
              <h4><span class="label label-info"><span class="fa fa-gamepad"></span> Counter-Strike: Global Offensive</span></h4>
              <h5>Watch Shroud live <a href="http://twitch.tv/">here.</a></h5>
            </div>
          </div>
          Shroud is replaced by the key's name element, Counter-Strike Global Offensive is replaced by streamData, and the twitch url is replaced by the key's twitch element.
          */
        }
      }
    }

    var cookieSet = Cookies.get();
    if ("streamerData" in cookieSet){
      var streamerData = Cookies.getJSON("streamerData");
      $('.username').html(" " + streamerData["username"]);
      var streamerListData = [];
      for (var key in streamerData["data"]){
        var tempDict = {};
        tempDict['name'] = streamerData["data"][key]["name"];
        tempDict['twitch'] = streamerData["data"][key]["twitch"];
        streamerListData[streamerData["data"][key]["name"]] = tempDict;
      }
      console.log(streamerListData);
      buildStreams(streamerData["data"],"#streamer-container");
      for (var key in streamerData["data"]){
        addStreamerItem('#new-streamer-list',streamerData["data"][key]["name"],streamerData["data"][key]["twitch"]);
      }
    }
    else{
      $('#createUserModal').modal('show');
    }
  </script>
</html>
